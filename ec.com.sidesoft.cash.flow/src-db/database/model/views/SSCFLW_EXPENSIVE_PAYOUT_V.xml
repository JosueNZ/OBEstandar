<?xml version="1.0"?>
  <database name="VIEW SSCFLW_EXPENSIVE_PAYOUT_V">
    <view name="SSCFLW_EXPENSIVE_PAYOUT_V"><![CDATA[SELECT get_uuid() AS sscflw_expensive_payout_v_id, rep.ad_org_id, rep.ad_client_id, rep.created, rep.createdby, rep.updated, rep.updatedby, rep.isactive, rep.cuenta_financiera, rep.fecha, rep.amount_pay, rep.fin_payment_id, rep.c_bpartner_id, rep.c_doctype_id, rep.amount, rep.c_glitem_id, rep.m_product_id, rep.prodname, rep.m_product_category_id, rep.c_elementvalue_id, rep.cuenta, rep.c_invoice_id, rep.fin_financial_account_id FROM (SELECT DISTINCT ffa.ad_org_id, ffa.ad_client_id, ffa.created, ffa.createdby, ffa.updated, ffa.updatedby, ffa.isactive, ffa.name AS cuenta_financiera, date(fft.dateacct) AS fecha, CASE WHEN rep_1.line = '1' THEN rep_1.new_totalline * rep_1.amount WHEN rep_1.line = '3' AND rep_1.c_glitem_id IS NULL THEN rep_1.new_totalline * rep_1.amount ELSE rep_1.amount END AS amount_pay, fft.fin_payment_id, rep_1.c_bpartner_id, rep_1.c_doctype_id, rep_1.amount, rep_1.c_glitem_id, rep_1.m_product_id, rep_1.prodname, rep_1.m_product_category_id, acct.c_elementvalue_id, acct.name AS cuenta, rep_1.c_invoice_id, ffa.fin_financial_account_id, rep_1.fin_payment_detail_id FROM fin_financial_account ffa JOIN fin_finacc_transaction fft ON ffa.fin_financial_account_id = fft.fin_financial_account_id JOIN (SELECT DISTINCT fp.fin_payment_id, fp.amount, fp.c_bpartner_id, cil.m_product_id, mp.name AS prodname, mp.m_product_category_id, ci.documentno, cil.linenetamt AS total_by_line, ci.totallines, cil.linenetamt / fpp.totallines AS new_totalline, fp.documentno AS paymentno, ci.c_doctype_id, CASE WHEN mp.isstocked = 'Y' THEN mpa.p_asset_acct ELSE mpa.p_expense_acct END AS account, '' AS c_glitem_id, '1' AS line, ci.c_invoice_id, '' AS fin_payment_detail_id FROM fin_payment fp JOIN fin_payment_detail fpd ON fpd.fin_payment_id = fp.fin_payment_id JOIN fin_payment_scheduledetail fpsd ON fpsd.fin_payment_detail_id = fpd.fin_payment_detail_id JOIN fin_payment_schedule fps ON fpsd.fin_payment_schedule_invoice = fps.fin_payment_schedule_id JOIN c_invoiceline cil ON cil.c_invoice_id = fps.c_invoice_id JOIN c_invoice ci ON ci.c_invoice_id = cil.c_invoice_id JOIN m_product mp ON mp.m_product_id = cil.m_product_id JOIN m_product_acct mpa ON mpa.m_product_id = mp.m_product_id JOIN (SELECT sum(rep_2.linenetamt) AS totallines, rep_2.fin_payment_id FROM (SELECT ci_1.c_invoice_id, cil_1.m_product_id, cil_1.linenetamt, fp_1.fin_payment_id FROM fin_payment fp_1 JOIN fin_payment_detail fpd_1 ON fpd_1.fin_payment_id = fp_1.fin_payment_id JOIN fin_payment_scheduledetail fpsd_1 ON fpsd_1.fin_payment_detail_id = fpd_1.fin_payment_detail_id JOIN fin_payment_schedule fps_1 ON fpsd_1.fin_payment_schedule_invoice = fps_1.fin_payment_schedule_id JOIN c_invoiceline cil_1 ON cil_1.c_invoice_id = fps_1.c_invoice_id JOIN c_invoice ci_1 ON ci_1.c_invoice_id = cil_1.c_invoice_id JOIN m_product mp_1 ON mp_1.m_product_id = cil_1.m_product_id JOIN m_product_acct mpa_1 ON mpa_1.m_product_id = mp_1.m_product_id WHERE fp_1.isreceipt = 'N' GROUP BY ci_1.c_invoice_id, cil_1.m_product_id, cil_1.linenetamt, fp_1.fin_payment_id) rep_2 GROUP BY rep_2.fin_payment_id) fpp ON fpp.fin_payment_id = fp.fin_payment_id WHERE fp.isreceipt = 'N' AND NOT (EXISTS (SELECT 1 FROM fin_payment_detail fpsd2 WHERE fpsd2.fin_payment_id = fp.fin_payment_id AND fpsd2.c_glitem_id IS NULL)) UNION ALL SELECT DISTINCT fp.fin_payment_id, fp.amount, fp.c_bpartner_id, cil.m_product_id, mp.name AS prodname, mp.m_product_category_id, ci.documentno, fpp.totallines AS total_by_line, CASE WHEN fpd.c_glitem_id IS NOT NULL THEN fpd.amount ELSE cil.linenetamt END AS amount2, CASE WHEN fpd.c_glitem_id IS NOT NULL THEN fpd.amount ELSE cil.linenetamt END / fpp.totallines AS new_totalline, fp.documentno AS paymentno, ci.c_doctype_id, CASE WHEN fpd.c_glitem_id IS NULL THEN CASE WHEN mp.isstocked = 'Y' THEN mpa.p_asset_acct ELSE mpa.p_expense_acct END ELSE gla.glitem_debit_acct END AS account, fpd.c_glitem_id, '1' AS line, ci.c_invoice_id, '' AS fin_payment_detail_id FROM fin_payment fp LEFT JOIN fin_payment_detail fpd ON fpd.fin_payment_id = fp.fin_payment_id LEFT JOIN fin_payment_scheduledetail fpsd ON fpsd.fin_payment_detail_id = fpd.fin_payment_detail_id LEFT JOIN fin_payment_schedule fps ON fpsd.fin_payment_schedule_invoice = fps.fin_payment_schedule_id LEFT JOIN c_invoiceline cil ON cil.c_invoice_id = fps.c_invoice_id LEFT JOIN c_invoice ci ON ci.c_invoice_id = cil.c_invoice_id LEFT JOIN m_product mp ON mp.m_product_id = cil.m_product_id LEFT JOIN m_product_acct mpa ON mpa.m_product_id = mp.m_product_id LEFT JOIN (SELECT sum(rep_2.linenetamt) AS totallines, rep_2.fin_payment_id FROM (SELECT ci_1.c_invoice_id, cil_1.m_product_id, CASE WHEN fpd_1.c_glitem_id IS NOT NULL THEN CASE WHEN fpd_1.amount < 0 THEN 0 ELSE fpd_1.amount END ELSE cil_1.linenetamt END AS linenetamt, fp_1.fin_payment_id FROM fin_payment fp_1 LEFT JOIN fin_payment_detail fpd_1 ON fpd_1.fin_payment_id = fp_1.fin_payment_id LEFT JOIN fin_payment_scheduledetail fpsd_1 ON fpsd_1.fin_payment_detail_id = fpd_1.fin_payment_detail_id LEFT JOIN fin_payment_schedule fps_1 ON fpsd_1.fin_payment_schedule_invoice = fps_1.fin_payment_schedule_id LEFT JOIN c_invoiceline cil_1 ON cil_1.c_invoice_id = fps_1.c_invoice_id LEFT JOIN c_invoice ci_1 ON ci_1.c_invoice_id = cil_1.c_invoice_id LEFT JOIN m_product mp_1 ON mp_1.m_product_id = cil_1.m_product_id LEFT JOIN m_product_acct mpa_1 ON mpa_1.m_product_id = mp_1.m_product_id WHERE fp_1.isreceipt = 'N' GROUP BY ci_1.c_invoice_id, cil_1.m_product_id, (CASE WHEN fpd_1.c_glitem_id IS NOT NULL THEN CASE WHEN fpd_1.amount < 0 THEN 0 ELSE fpd_1.amount END ELSE cil_1.linenetamt END), fp_1.fin_payment_id) rep_2 GROUP BY rep_2.fin_payment_id) fpp ON fpp.fin_payment_id = fp.fin_payment_id LEFT JOIN c_glitem_acct gla ON fpd.c_glitem_id = gla.c_glitem_id WHERE fp.isreceipt = 'N' AND (EXISTS (SELECT 1 FROM fin_payment_detail fpsd2 WHERE fpsd2.fin_payment_id = fp.fin_payment_id AND fpsd2.c_glitem_id IS NULL)) AND fp.amount > 0 UNION ALL SELECT fp.fin_payment_id, fpd.amount, fp.c_bpartner_id, '' AS m_product_id, gl.name AS item, '' AS m_product_category_id, '' AS documento, fpd.amount AS total_by_line, fpd.amount AS totallines, fpd.amount AS new_totalline, fp.documentno AS paymentno, '' AS c_doctype_id, gla.glitem_debit_acct AS account, gl.c_glitem_id, '2' AS line, '' AS c_invoice_id, fpd.fin_payment_detail_id FROM fin_payment fp JOIN fin_payment_detail fpd ON fpd.fin_payment_id = fp.fin_payment_id JOIN c_glitem gl ON fpd.c_glitem_id = gl.c_glitem_id JOIN c_glitem_acct gla ON gl.c_glitem_id = gla.c_glitem_id WHERE fp.isreceipt = 'N' AND NOT (EXISTS (SELECT 1 FROM fin_payment_detail fpsd2 WHERE fpsd2.fin_payment_id = fp.fin_payment_id AND fpsd2.c_glitem_id IS NULL)) UNION ALL SELECT DISTINCT fp.fin_payment_id, fp.amount, fp.c_bpartner_id, '' AS m_product_id, '' AS prodname, '' AS m_product_category_id, fp.documentno, 0 AS total_by_line, fpsd.amount AS totallines, 1 AS new_totalline, fp.documentno AS paymentno, fp.c_doctype_id, cbva.v_prepayment_acct AS account, '' AS c_glitem_id, '3' AS line, '' AS c_invoice_id, fpd.fin_payment_detail_id FROM fin_payment fp JOIN fin_payment_detail fpd ON fpd.fin_payment_id = fp.fin_payment_id LEFT JOIN fin_payment_scheduledetail fpsd ON fpsd.fin_payment_detail_id = fpd.fin_payment_detail_id LEFT JOIN fin_payment_schedule fps ON fpsd.fin_payment_schedule_invoice = fps.fin_payment_schedule_id LEFT JOIN c_bp_vendor_acct cbva ON cbva.c_bpartner_id = fp.c_bpartner_id JOIN (SELECT fact_acct.account_id, fact_acct.record_id FROM fact_acct WHERE fact_acct.ad_table_id = 'D1A97202E832470285C9B1EB026D54E2' AND fact_acct.amtacctcr > 0) fact ON fact.record_id = fp.fin_payment_id WHERE fp.isreceipt = 'N' AND fpsd.fin_payment_schedule_invoice IS NULL AND fpd.c_glitem_id IS NULL) rep_1 ON fft.fin_payment_id = rep_1.fin_payment_id LEFT JOIN (c_validcombination cv JOIN c_elementvalue cev ON cev.c_elementvalue_id = cv.account_id) acct(c_validcombination_id, ad_client_id, ad_org_id, isactive, created, createdby, updated, updatedby, alias, combination, description, isfullyqualified, c_acctschema_id, account_id, m_product_id, c_bpartner_id, ad_orgtrx_id, c_locfrom_id, c_locto_id, c_salesregion_id, c_project_id, c_campaign_id, c_activity_id, user1_id, user2_id, c_elementvalue_id, ad_client_id_1, ad_org_id_1, isactive_1, created_1, createdby_1, updated_1, updatedby_1, value, name, description_1, accounttype, accountsign, isdoccontrolled, c_element_id, issummary, validfrom, validto, postactual, postbudget, postencumbrance, poststatistical, isbankaccount, c_bankaccount_id, isforeigncurrency, c_currency_id, showelement, showvaluecond, elementlevel, isalwaysshown, em_ssfi_iscostcenter, em_ssfi_isuser1, em_ssfi_isuser2, em_ssam_asset, em_slcmvl_account_acct) ON rep_1.account = acct.c_validcombination_id WHERE ffa.type = 'B' AND fft.trxtype = 'BPW') rep WHERE rep.amount_pay > 0]]></view>
  </database>
