<?xml version="1.0"?>
  <database name="VIEW SRSI_SALESINVOICE_V">
    <view name="SRSI_SALESINVOICE_V"><![CDATA[SELECT inv.c_invoice_id AS srsi_salesinvoice_v_id, inv.ad_client_id, inv.ad_org_id, inv.isactive, inv.created, inv.createdby, inv.updated, inv.updatedby, to_char(substr(inv.documentno, 9)) AS num_invoice, to_char(substr(inv.documentno, 1, 3)) AS establishment, to_char(substr(inv.documentno, 5, 3)) AS box, inv.dateinvoiced, round(sum(CASE WHEN dty.docbasetype = 'ARI' THEN il.linenetamt ELSE abs(il.linenetamt) * (-1) END), 2) AS linenetamt, round(CASE WHEN dty.docbasetype = 'ARI' THEN inv.grandtotal ELSE abs(inv.grandtotal) * (-1) END, 2) AS grandtotal, round(CASE WHEN dty.docbasetype = 'ARI' THEN inv.grandtotal - inv.totallines ELSE abs(inv.grandtotal - inv.totallines) * (-1) END, 2) AS totaliva, inv.c_bpartner_id AS c_bpartner_id_cod, inv.c_bpartner_id AS c_bpartner_id_name, inv.salesrep_id AS ad_user_id, bp.c_bp_group_id, fps.duedate, srsi_report_salesinvoice(inv.c_invoice_id, 'CAT') AS m_product_category_id, srsi_report_salesinvoice(inv.c_invoice_id, 'WAREHOUSE') AS m_warehouse_id, inv.c_doctype_id, round(CASE WHEN dty.docbasetype = 'ARI' THEN to_number(srsi_report_salesinvoice(inv.c_invoice_id, 'DESC')) ELSE abs(to_number(srsi_report_salesinvoice(inv.c_invoice_id, 'DESC'))) * (-1) END, 2) AS discount, to_date(srsi_report_salesinvoice(inv.c_invoice_id, 'DATEINV'), 'YYYY-MM-DD 24H:min:ss') AS movementdate, CASE WHEN dty.docbasetype = 'ARI' THEN round(round(sum(il.linenetamt), 2) + round(to_number(srsi_report_salesinvoice(inv.c_invoice_id, 'DESC')), 2), 2) ELSE round(sum(il.linenetamt) + to_number(srsi_report_salesinvoice(inv.c_invoice_id, 'DESC')), 2) * (-1) END AS totaltotal, inv.em_scnr_invoice_id AS c_invoice_id FROM c_invoice inv JOIN c_doctype dty ON inv.c_doctype_id = dty.c_doctype_id JOIN c_bpartner bp ON inv.c_bpartner_id = bp.c_bpartner_id JOIN c_invoiceline il ON inv.c_invoice_id = il.c_invoice_id JOIN ad_org o ON inv.ad_org_id = o.ad_org_id LEFT JOIN ad_user u ON inv.salesrep_id = u.ad_user_id JOIN c_bp_group bpgr ON bpgr.c_bp_group_id = bp.c_bp_group_id LEFT JOIN (SELECT fin_payment_schedule.c_invoice_id, max(fin_payment_schedule.duedate) AS duedate FROM fin_payment_schedule WHERE fin_payment_schedule.c_invoice_id IS NOT NULL GROUP BY fin_payment_schedule.c_invoice_id) fps ON fps.c_invoice_id = inv.c_invoice_id WHERE inv.issotrx = 'Y' AND inv.docstatus = 'CO' AND dty.em_sswh_implementautoriza = 'Y' GROUP BY inv.c_invoice_id, inv.ad_client_id, inv.ad_org_id, inv.isactive, inv.created, inv.createdby, inv.updated, inv.updatedby, inv.documentno, inv.dateinvoiced, inv.grandtotal, inv.totallines, inv.c_bpartner_id, inv.salesrep_id, u.ad_user_id, dty.docbasetype, bp.c_bp_group_id, fps.duedate, inv.c_doctype_id, inv.em_scnr_invoice_id]]></view>
  </database>
